<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title data-i18n="title">üì∏ Foto Galerija</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg:#0f0f0f; --panel:#1a1a1a; --muted:#999; --accent:#6ea8fe; --btn:#2a2a2a; --btn-b:#3a3a3a; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: #fff; }
        .header { display:grid; gap:6px; text-align:center; padding: 24px 16px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); border-radius: 0 0 14px 14px; }
        .header h1 { font-size: clamp(22px, 4.5vw, 40px); margin-bottom: 2px; }
        .header p { opacity: .95; font-size: 16px; }
        .lang { position: absolute; right: 10px; top: 10px; display:flex; gap:6px; }
        .lang button { padding:6px 10px; border-radius:8px; border:1px solid #ffffff33; background:#00000022; color:#fff; cursor:pointer; font-weight:600; }
        .lang button.active { background: #ffffff2e; }

        .topbar { display:flex; gap:10px; align-items:center; padding: 10px; position: sticky; top: 0; background: var(--bg); z-index: 5; }
        .folders { display:flex; gap:10px; overflow-x:auto; padding: 10px; background: var(--panel); }
        .folder-btn { flex:0 0 auto; padding:12px 16px; background:var(--btn); border:2px solid var(--btn-b); color:#fff; border-radius:10px; font-size:16px; min-width:120px; text-align:center; }
        .folder-btn.active { background: linear-gradient(135deg,#667eea,#764ba2); border-color:#667eea; }

        .grid { display:grid; gap:10px; padding:10px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
        @media (min-width: 900px){ .grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); } }
        .card { position:relative; aspect-ratio:1; border-radius:12px; overflow:hidden; background:var(--panel); }
        .card img { width:100%; height:100%; object-fit:cover; display:block; }
        .badge { position:absolute; left:8px; top:8px; background: rgba(0,0,0,.55); padding:6px 10px; border-radius:8px; font-size:14px; backdrop-filter: blur(2px); }
        .empty { text-align:center; color:var(--muted); padding:40px 16px; }

        /* Lightbox */
        .lightbox { position:fixed; inset:0; display:none; justify-content:center; align-items:center; background: rgba(0,0,0,.96); z-index:50; }
        .lightbox.active { display:flex; }
        .lb-img { max-width:96vw; max-height:88vh; border-radius:10px; touch-action: pan-y; }
        .lb-close, .lb-nav { position:absolute; display:grid; place-items:center; width:56px; height:56px; border-radius:50%; background: rgba(255,255,255,.12); border:0; color:#fff; cursor:pointer; }
        .lb-close { right:16px; top:16px; font-size:34px; }
        .lb-prev { left:12px; top:50%; transform: translateY(-50%); font-size:44px; }
        .lb-next { right:12px; top:50%; transform: translateY(-50%); font-size:44px; }
        .lb-close:active, .lb-nav:active { background: rgba(255,255,255,.2); }
        .tip { text-align:center; color:#bbb; font-size:13px; padding: 6px 0 10px; }
    </style>
</head>
<body>
<div class="lang" aria-label="Language switch">
    <button id="btnSR">SR</button>
    <button id="btnEN">EN</button>
</div>

<div class="header">
    <h1 data-i18n="title">üì∏ Foto Galerija</h1>
    <p data-i18n="subtitle">Uhvatite trenutke. Saƒçuvajte uspomene. U≈æivajte ponovo.</p>
</div>

<div class="topbar">
    <div class="tip" data-i18n="tip">Prevucite listu foldera ¬ª</div>
</div>

<div class="folders" id="folders"><div class="empty" data-i18n="loadingFolders">Uƒçitavam foldere‚Ä¶</div></div>
<div class="grid" id="grid"><div class="empty" data-i18n="loadingImages">Uƒçitavam slike‚Ä¶</div></div>

<div class="lightbox" id="lightbox" aria-hidden="true">
    <button class="lb-close" id="btnClose" aria-label="Zatvori" data-i18n-aria="closeLabel">√ó</button>
    <button class="lb-nav lb-prev" id="btnPrev" aria-label="Prethodna" data-i18n-aria="prevLabel">‚Äπ</button>
    <img class="lb-img" id="lbImg" alt="">
    <button class="lb-nav lb-next" id="btnNext" aria-label="Sledeƒáa" data-i18n-aria="nextLabel">‚Ä∫</button>
</div>

<script>
    (() => {
      // ===== Endpoints & global version =====
      const API_BASE    = ''; // isti host/port (http://localhost:5000)
      const GALLERY_URL = `${API_BASE}/api/gallery`;
      const STREAM_URL  = `${API_BASE}/api/sse/stream`;
      let version = 0;

      // ===== i18n strings =====
      const STR = {
        sr: {
          title: "üì∏ Foto Galerija",
          subtitle: "Uhvatite trenutke. Saƒçuvajte uspomene. U≈æivajte ponovo.",
          tip: "Prevucite listu foldera ¬ª",
          loadingFolders: "Uƒçitavam foldere‚Ä¶",
          loadingImages: "Uƒçitavam slike‚Ä¶",
          noFolders: "Nema foldera",
          addImagesToFolders: "Dodajte slike u foldere",
          noImages: "Nema slika u ovom folderu",
          closeLabel: "Zatvori",
          prevLabel: "Prethodna",
          nextLabel: "Sledeƒáa"
        },
        en: {
          title: "üì∏ Photo Gallery",
          subtitle: "Capture moments. Keep memories. Relive the joy.",
          tip: "Swipe the folders list ¬ª",
          loadingFolders: "Loading folders‚Ä¶",
          loadingImages: "Loading images‚Ä¶",
          noFolders: "No folders",
          addImagesToFolders: "Add images to folders",
          noImages: "No images in this folder",
          closeLabel: "Close",
          prevLabel: "Previous",
          nextLabel: "Next"
        }
      };

      const LS_LANG = "gallery:lang";
      const LAST_FOLDER_KEY = "gallery:lastFolder";

      // ===== language =====
      let lang = (localStorage.getItem(LS_LANG) || autoLang()).toLowerCase();
      if (!STR[lang]) lang = "sr";
      document.documentElement.lang = lang;

      const btnSR = document.getElementById("btnSR");
      const btnEN = document.getElementById("btnEN");
      btnSR.onclick = () => setLang("sr");
      btnEN.onclick = () => setLang("en");
      refreshLangButtons();
      applyI18n();

      function autoLang(){
        const b = (navigator.language || "sr").toLowerCase();
        return b.startsWith("sr") ? "sr" : "en";
      }
      function setLang(l){
        lang = l;
        localStorage.setItem(LS_LANG, l);
        document.documentElement.lang = l;
        refreshLangButtons();
        applyI18n();
        renderFolders();
        renderGrid();
      }
      function refreshLangButtons(){
        btnSR.classList.toggle("active", lang==="sr");
        btnEN.classList.toggle("active", lang==="en");
      }
      function t(key){ return (STR[lang] && STR[lang][key]) || key; }
      function applyI18n(){
        document.querySelectorAll("[data-i18n]").forEach(el => {
          el.textContent = t(el.getAttribute("data-i18n"));
        });
        document.querySelectorAll("[data-i18n-aria]").forEach(el => {
          const attr = el.getAttribute("data-i18n-aria");
          el.setAttribute("aria-label", t(attr));
        });
      }

      // ===== gallery state =====
      let data = {};      // { folder: [{name,url,mtime}, ...] }
      let currentFolder = null;
      let current = [];
      let idx = 0;

      // ===== elements =====
      const elFolders = document.getElementById('folders');
      const elGrid    = document.getElementById('grid');
      const lb        = document.getElementById('lightbox');
      const lbImg     = document.getElementById('lbImg');
      const btnPrev   = document.getElementById('btnPrev');
      const btnNext   = document.getElementById('btnNext');
      const btnClose  = document.getElementById('btnClose');

      // ===== boot =====
      init();

      async function init(){
        await refreshGallery();
        connectStream();
      }

      function renderFolders(){
        const folders = Object.keys(data).sort();
        if (folders.length === 0) {
          elFolders.innerHTML = `<div class="empty">${t("noFolders")}</div>`;
          elGrid.innerHTML    = `<div class="empty">${t("addImagesToFolders")}</div>`;
          currentFolder = null;
          return;
        }
        const saved = localStorage.getItem(LAST_FOLDER_KEY);
        currentFolder = (saved && folders.includes(saved))
          ? saved
          : (currentFolder && folders.includes(currentFolder)) ? currentFolder : folders[0];
        localStorage.setItem(LAST_FOLDER_KEY, currentFolder);

        elFolders.innerHTML = '';
        folders.forEach(f => {
          const b = document.createElement('button');
          b.className = 'folder-btn' + (f===currentFolder?' active':'');
          b.textContent = f;
          b.onclick = () => {
            currentFolder = f;
            localStorage.setItem(LAST_FOLDER_KEY, f);
            renderFolders();
            renderGrid();
          };
          elFolders.appendChild(b);
        });
      }

      function renderGrid(){
        if (!currentFolder || !data[currentFolder] || data[currentFolder].length===0){
          elGrid.innerHTML = `<div class="empty">${t("noImages")}</div>`;
          current = [];
          return;
        }
        current = data[currentFolder].slice()
          .sort((a,b)=>a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
        elGrid.innerHTML = '';
        for (let i=0;i<current.length;i++){
          const img = current[i];
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `<img src="${img.url}" loading="lazy" alt="${img.name}"><div class="badge">${img.name}</div>`;
          card.onclick = () => openLightbox(i);
          elGrid.appendChild(card);
        }
      }

      async function refreshGallery(){
        try {
          const res  = await fetch(`${GALLERY_URL}?_=${Date.now()}`, { cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          // prihvati i ƒçistu mapu i {data:{...}}
          data = json?.data ?? json;
          // mali debug u konzoli:
          console.log('Folders:', Object.keys(data).length, Object.keys(data));
          renderFolders();
          renderGrid();
        } catch (e) {
          console.error('refreshGallery error:', e);
          elFolders.innerHTML = `<div class="empty">${t("loadingFolders")}</div>`;
          elGrid.innerHTML    = `<div class="empty">${t("loadingImages")}</div>`;
        }
      }

      function connectStream(){
        try {
          const es = new EventSource(STREAM_URL);

          es.addEventListener('version', ev => {
            const v = parseInt(ev.data, 10);
            if (!Number.isNaN(v) && v > version) {
              version = v;
              refreshGallery();
            }
          });

          es.addEventListener('ping', () => { /* keepalive */ });

          es.onerror = () => {
            try { es.close(); } catch {}
            setTimeout(connectStream, 2000);   // reconnect
          };
        } catch (e) {
          setTimeout(connectStream, 4000);
        }
      }

      // ===== Lightbox =====
      function openLightbox(i){
        idx = i;
        lbImg.src = current[idx].url;
        lb.classList.add('active');
        lb.setAttribute('aria-hidden','false');
      }
      function closeLightbox(){
        lb.classList.remove('active');
        lb.setAttribute('aria-hidden','true');
        lbImg.src = '';
      }
      function next(n){
        if (!current.length) return;
        idx = (idx + n + current.length) % current.length;
        lbImg.src = current[idx].url;
      }
      btnPrev.onclick = () => next(-1);
      btnNext.onclick = () => next(1);
      btnClose.onclick = closeLightbox;
      lb.addEventListener('click', (e)=>{ if (e.target===lb) closeLightbox(); });

      // Swipe
      let touchX = null, touchY = null;
      lbImg.addEventListener('touchstart', (e) => {
        const t = e.touches[0]; touchX = t.clientX; touchY = t.clientY;
      }, {passive:true});
      lbImg.addEventListener('touchend', (e) => {
        if (touchX===null) return;
        const dx = (e.changedTouches[0].clientX - touchX);
        const dy = (e.changedTouches[0].clientY - touchY);
        if (Math.abs(dx) > 40 && Math.abs(dy) < 60){
          if (dx < 0) next(1); else next(-1);
        }
        touchX = touchY = null;
      }, {passive:true});

      window.addEventListener('keydown', (e)=>{
        if (!lb.classList.contains('active')) return;
        if (e.key === 'ArrowRight') next(1);
        else if (e.key === 'ArrowLeft') next(-1);
        else if (e.key === 'Escape') closeLightbox();
      });
    })();
</script>

</body>
</html>
